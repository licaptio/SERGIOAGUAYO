<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga de XML ‚Äì Ingresos SALVADOR RIOS QUEZADA</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; color:#111; }
    h2 { color: #00416A; }
    ul { padding: 0; list-style: none; }
    li { margin-bottom: 6px; font-size: 14px; }
    .ok { color: green; }
    .warn { color: orange; }
    .err { color: red; }
    .pending { color: blue; }
    pre { background:#eee; padding:10px; max-height:240px; overflow:auto; font-size:13px; }
    .progress-bar { width:100%; background:#ddd; border-radius:4px; overflow:hidden; height:16px; margin-top:6px; }
    .progress-bar div { height:100%; width:0%; background:#0c6cbd; transition:width 0.3s ease; }
  </style>
</head>

<body>

<h2>
  Subir CFDI v√°lidos (tipo I, emisor <b>RIQS740906PQ2</b>,  
  sin n√≥mina / egreso / carta porte / pagos)
</h2>

<input type="file" id="xmlInput" accept=".xml" multiple>
<button onclick="procesarArchivos()">Procesar y Subir</button>

<div class="progress-bar"><div id="progreso"></div></div>

<h3>Archivos</h3>
<ul id="archivoList"></ul>

<h3>Bit√°cora</h3>
<pre id="bitacora"></pre>

<script>
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
const TABLA = "ingresosriqs740906pq2";
const RFC_VALIDO = "RIQS740906PQ2";

let archivosDatos = [];

document.getElementById("xmlInput").addEventListener("change", async function () {
  const lista = document.getElementById("archivoList");
  lista.innerHTML = "";
  archivosDatos = [];

  for (const file of this.files) {
    try {
      const text = await file.text();
      const xml = new DOMParser().parseFromString(text, "application/xml");

      const ns = "http://www.sat.gob.mx/cfd/4";
      const comprobante = xml.getElementsByTagNameNS(ns, "Comprobante")[0];
      const emisor = xml.getElementsByTagNameNS(ns, "Emisor")[0];
      const receptor = xml.getElementsByTagNameNS(ns, "Receptor")[0];

      let timbre = [...xml.getElementsByTagName("*")]
        .find(n => n.localName === "TimbreFiscalDigital");

      const uuid = timbre?.getAttribute("UUID")?.toUpperCase() || "";
      const tipo = comprobante?.getAttribute("TipoDeComprobante") || "";
      const emisorRFC = emisor?.getAttribute("Rfc")?.toUpperCase() || "";

      let valido = true, motivo = "";
      if (!uuid) motivo = "sin UUID", valido = false;
      else if (archivosDatos.some(a => a.uuid === uuid)) motivo = "duplicado en lote", valido = false;
      else if (tipo !== "I") motivo = `tipo ${tipo}`, valido = false;
      else if (emisorRFC !== RFC_VALIDO) motivo = `emisor ${emisorRFC}`, valido = false;

      if (!valido) {
        lista.innerHTML += `<li>‚ùå <b>${file.name}</b> <span class="err">‚Üí ${motivo}</span></li>`;
        continue;
      }

      const fecha = comprobante.getAttribute("Fecha");
      const fechaTimbrado = timbre.getAttribute("FechaTimbrado");
      const receptorRFC = receptor.getAttribute("Rfc") || "";
      const tipoFactura = receptorRFC === "XAXX010101000" ? "GLOBAL" : "INDIVIDUAL";

      archivosDatos.push({
        uuid,
        fecha,
        periodoMes: fecha.substring(5,7),
        periodoAnio: fecha.substring(0,4),
        tipoFactura,
        emisorRFC,
        razonSocial: emisor.getAttribute("Nombre") || "",
        receptorRFC,
        receptorNombre: receptor.getAttribute("Nombre") || "",
        folio: comprobante.getAttribute("Folio") || "",
        serie: comprobante.getAttribute("Serie") || "",
        subtotal: parseFloat(comprobante.getAttribute("SubTotal") || 0),
        descuento: parseFloat(comprobante.getAttribute("Descuento") || 0),
        total: parseFloat(comprobante.getAttribute("Total") || 0),
        moneda: comprobante.getAttribute("Moneda") || "",
        formaPago: comprobante.getAttribute("FormaPago") || "",
        metodoPago: comprobante.getAttribute("MetodoPago") || "",
        usoCFDI: receptor.getAttribute("UsoCFDI") || "",
        selloSAT: timbre.getAttribute("SelloSAT") || "",
        noCertificadoSAT: timbre.getAttribute("NoCertificadoSAT") || "",
        fecha_certificacion: fechaTimbrado,
        totalIVA: 0,
        totalIEPS: 0,
        ivaDetalle: [],
        iepsDetalle: [],
        conceptos: []
      });

      lista.innerHTML += `<li data-uuid="${uuid}">üìÑ ${uuid} <span class="pending">‚Üí Precargado</span></li>`;

    } catch (e) {
      lista.innerHTML += `<li class="err">‚ùå Error ${file.name}</li>`;
    }
  }
});

async function procesarArchivos() {
  for (const data of archivosDatos) {
    await fetch(`${SUPABASE_URL}/rest/v1/${TABLA}`, {
      method: "POST",
      headers: {
        apikey: API_KEY,
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        uuid_cfdi: data.uuid,
        fecha: data.fecha,
        periodo_mes: data.periodoMes,
        periodo_anio: data.periodoAnio,
        tipo_factura: data.tipoFactura,
        rfc_emisor: data.emisorRFC,
        razon_social_emisor: data.razonSocial,
        rfc_receptor: data.receptorRFC,
        razon_social_receptor: data.receptorNombre,
        folio: data.folio,
        serie: data.serie,
        subtotal: data.subtotal,
        descuento: data.descuento,
        total: data.total,
        moneda: data.moneda,
        forma_pago: data.formaPago,
        metodo_pago: data.metodoPago,
        uso_cfdi: data.usoCFDI,
        sello_sat: data.selloSAT,
        no_certificado_sat: data.noCertificadoSAT,
        fecha_certificacion: data.fecha_certificacion,
        total_iva: data.totalIVA,
        total_ieps: data.totalIEPS,
        iva_detalle: data.ivaDetalle,
        ieps_detalle: data.iepsDetalle,
        conceptos: data.conceptos
      })
    });
  }
}
async function procesarArchivos() {
  console.log("CLICK PROCESAR");
  console.log("TOTAL ARCHIVOS:", archivosDatos.length);

  for (const data of archivosDatos) {
    console.log("ENVIANDO UUID:", data.uuid);

    await fetch(`${SUPABASE_URL}/rest/v1/${TABLA}`, {
      method: "POST",
      headers: {
        apikey: API_KEY,
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        uuid_cfdi: data.uuid,
        rfc_emisor: data.emisorRFC,
        rfc_receptor: data.receptorRFC,
        total: data.total
      })
    });
  }
}

</script>

<footer style="margin-top:40px;text-align:center;font-size:13px;color:#555;border-top:1px solid #ccc;padding:10px">
  ‚öôÔ∏è POWERED BY <b>PROVSOFT</b> ¬∑ 2026 ¬∑ Sistema de integraci√≥n CFDI 4.0
</footer>

</body>
</html>


