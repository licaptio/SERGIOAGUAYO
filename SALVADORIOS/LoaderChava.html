<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Loader CFDI FULL SAT ¬∑ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Poppins,Arial;background:#f9f9f9;padding:20px}
h2{color:#00416A}
ul{list-style:none;padding:0}
li{font-size:14px;margin-bottom:6px}
.ok{color:green}
.warn{color:orange}
.err{color:red}
.pending{color:blue}
</style>
</head>
<body>

<h2>CFDI Ingreso ¬∑ RIQS740906PQ2 ¬∑ FULL SAT</h2>

<input type="file" id="xmlInput" accept=".xml" multiple>
<button onclick="procesar()">Procesar y Subir</button>
<ul id="lista"></ul>

<script>
const SUPABASE_URL='https://cvpbtjlupswbyxenugpz.supabase.co';
const API_KEY='TU_API_KEY';
const TABLA='ingresosriqs740906pq2';
const RFC_VALIDO='RIQS740906PQ2';

let lote=[];

xmlInput.addEventListener('change', async e=>{
  lote=[]; lista.innerHTML='';
  for(const file of e.target.files){
    try{
      const xmlTxt=await file.text();
      const xml=new DOMParser().parseFromString(xmlTxt,'application/xml');
      const ns='http://www.sat.gob.mx/cfd/4';

      const c=xml.getElementsByTagNameNS(ns,'Comprobante')[0];
      const em=xml.getElementsByTagNameNS(ns,'Emisor')[0];
      const re=xml.getElementsByTagNameNS(ns,'Receptor')[0];
      const tfd=[...xml.getElementsByTagName('*')].find(n=>n.localName==='TimbreFiscalDigital');

      if(!c||!em||!re||!tfd) throw 'XML incompleto';

      if(em.getAttribute('Rfc')!==RFC_VALIDO) throw 'RFC distinto';
      if(c.getAttribute('TipoDeComprobante')!=='I') throw 'No Ingreso';

      const conceptos=[...xml.getElementsByTagNameNS(ns,'Concepto')].map(cx=>({
        clave_prod_serv:cx.getAttribute('ClaveProdServ'),
        no_identificacion:cx.getAttribute('NoIdentificacion'),
        cantidad:Number(cx.getAttribute('Cantidad')),
        clave_unidad:cx.getAttribute('ClaveUnidad'),
        unidad:cx.getAttribute('Unidad'),
        descripcion:cx.getAttribute('Descripcion'),
        valor_unitario:Number(cx.getAttribute('ValorUnitario')),
        importe:Number(cx.getAttribute('Importe')),
        descuento:Number(cx.getAttribute('Descuento')||0),
        objeto_impuesto:cx.getAttribute('ObjetoImp')
      }));

      lote.push({
        uuid_cfdi:tfd.getAttribute('UUID'),
        fecha:new Date(c.getAttribute('Fecha')).toISOString(),
        fecha_certificacion:new Date(tfd.getAttribute('FechaTimbrado')).toISOString(),
        periodo_mes:c.getAttribute('Fecha').slice(5,7),
        periodo_anio:c.getAttribute('Fecha').slice(0,4),
        serie:c.getAttribute('Serie'),
        folio:c.getAttribute('Folio'),
        subtotal:Number(c.getAttribute('SubTotal')),
        descuento:Number(c.getAttribute('Descuento')||0),
        total:Number(c.getAttribute('Total')),
        moneda:c.getAttribute('Moneda'),
        forma_pago:c.getAttribute('FormaPago'),
        metodo_pago:c.getAttribute('MetodoPago'),

        emisor:{
          rfc:em.getAttribute('Rfc'),
          nombre:em.getAttribute('Nombre'),
          regimen:em.getAttribute('RegimenFiscal')
        },

        receptor:{
          rfc:re.getAttribute('Rfc'),
          nombre:re.getAttribute('Nombre'),
          uso_cfdi:re.getAttribute('UsoCFDI'),
          regimen:re.getAttribute('RegimenFiscalReceptor'),
          cp:re.getAttribute('DomicilioFiscalReceptor')
        },

        comprobante:Object.fromEntries([...c.attributes].map(a=>[a.name,a.value])),
        timbre:Object.fromEntries([...tfd.attributes].map(a=>[a.name,a.value])),

        sello_cfdi:c.getAttribute('Sello'),
        no_certificado:c.getAttribute('NoCertificado'),
        certificado_sat:tfd.getAttribute('NoCertificadoSAT'),
        xml_original:xmlTxt,
        conceptos
      });

      lista.innerHTML+=`<li data-u="${tfd.getAttribute('UUID')}">üìÑ ${tfd.getAttribute('UUID')} <span class="pending">‚Üí Precargado</span></li>`;
    }catch(err){
      lista.innerHTML+=`<li class="err">‚ùå ${file.name} (${err})</li>`;
    }
  }
});

async function procesar(){
  for(const r of lote){
    const li=document.querySelector(`li[data-u="${r.uuid_cfdi}"] span`);
    li.textContent='‚Üí Insertando‚Ä¶';
    const res=await fetch(`${SUPABASE_URL}/rest/v1/${TABLA}`,{
      method:'POST',
      headers:{
        apikey:API_KEY,
        Authorization:`Bearer ${API_KEY}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify(r)
    });
    li.textContent=res.status===201?'‚úÖ Insertado':'‚ùå Error';
    li.className=res.status===201?'ok':'err';
  }
}
</script>

</body>
</html>
