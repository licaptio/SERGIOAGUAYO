<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Loader CFDI FULL SAT ¬∑ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Poppins,Arial;background:#f9f9f9;padding:20px}
h2{color:#00416A}
ul{list-style:none;padding:0}
li{font-size:14px;margin-bottom:6px}
.ok{color:green}
.warn{color:orange}
.err{color:red}
.pending{color:blue}
</style>
</head>

<body>

<h2>CFDI Ingreso ¬∑ RIQS740906PQ2 ¬∑ FULL SAT</h2>

<input type="file" id="xmlInput" accept=".xml" multiple>
<button onclick="procesar()">Procesar y Subir</button>

<ul id="lista"></ul>

<script>
const SUPABASE_URL='https://cvpbtjlupswbyxenugpz.supabase.co';
const API_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY';
const TABLA='ingresosriqs740906pq2';
const RFC_VALIDO='RIQS740906PQ2';

let lote=[];

document.getElementById('xmlInput').addEventListener('change', async e=>{
  lote=[];
  lista.innerHTML='';
  for(const file of e.target.files){
    try{
      const xmlTxt=await file.text();
      const xml=new DOMParser().parseFromString(xmlTxt,'application/xml');

      const ns='http://www.sat.gob.mx/cfd/4';
      const c=xml.getElementsByTagNameNS(ns,'Comprobante')[0];
      const em=xml.getElementsByTagNameNS(ns,'Emisor')[0];
      const re=xml.getElementsByTagNameNS(ns,'Receptor')[0];
      const tfd=[...xml.getElementsByTagName('*')].find(n=>n.localName==='TimbreFiscalDigital');

      if(!c||!em||!re||!tfd) throw 'XML incompleto';

      const uuid=tfd.getAttribute('UUID')?.toUpperCase();
      if(!uuid) throw 'Sin UUID';
      if(c.getAttribute('TipoDeComprobante')!=='I') throw 'No Ingreso';
      if(em.getAttribute('Rfc')!==RFC_VALIDO) throw 'RFC distinto';

      const fecha=new Date(c.getAttribute('Fecha')).toISOString();
      const conceptos=[...xml.getElementsByTagNameNS(ns,'Concepto')].map(cx=>({
        cantidad:Number(cx.getAttribute('Cantidad')),
        descripcion:cx.getAttribute('Descripcion'),
        valor_unitario:Number(cx.getAttribute('ValorUnitario')),
        importe:Number(cx.getAttribute('Importe'))
      }));

      lote.push({
        uuid_cfdi:uuid,
        fecha,
        fecha_certificacion:new Date(tfd.getAttribute('FechaTimbrado')).toISOString(),
        periodo_mes:fecha.slice(5,7),
        periodo_anio:fecha.slice(0,4),
        tipo_factura:'INDIVIDUAL',
        rfc_emisor:em.getAttribute('Rfc'),
        razon_social_emisor:em.getAttribute('Nombre'),
        rfc_receptor:re.getAttribute('Rfc'),
        razon_social_receptor:re.getAttribute('Nombre'),
        uso_cfdi:re.getAttribute('UsoCFDI'),
        serie:c.getAttribute('Serie'),
        folio:c.getAttribute('Folio'),
        subtotal:Number(c.getAttribute('SubTotal')),
        descuento:Number(c.getAttribute('Descuento')||0),
        total:Number(c.getAttribute('Total')),
        moneda:c.getAttribute('Moneda'),
        forma_pago:c.getAttribute('FormaPago'),
        metodo_pago:c.getAttribute('MetodoPago'),
        total_iva:null,
        total_ieps:null,
        conceptos
      });

      lista.innerHTML+=`<li data-u="${uuid}">üìÑ ${uuid} <span class="pending">‚Üí Precargado</span></li>`;
    }catch(e){
      lista.innerHTML+=`<li class="err">‚ùå ${file.name} (${e})</li>`;
    }
  }
});

async function procesar(){
  for(const r of lote){
    const li=document.querySelector(`li[data-u="${r.uuid_cfdi}"] span`);
    li.textContent='‚Üí Insertando‚Ä¶';
    const res=await fetch(`${SUPABASE_URL}/rest/v1/${TABLA}`,{
      method:'POST',
      headers:{
        apikey:API_KEY,
        Authorization:`Bearer ${API_KEY}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify(r)
    });
    li.textContent=res.status===201?'‚úÖ Insertado':'‚ùå Error';
    li.className=res.status===201?'ok':'err';
  }
}
</script>

</body>
</html>
