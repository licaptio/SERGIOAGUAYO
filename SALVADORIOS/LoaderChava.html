<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Carga de XML ‚Äì Ingresos SALVADOR RIOS QUEZADA ¬∑ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;padding:20px;background:#f9f9f9}
h2{color:#00416A}
ul{list-style:none;padding:0}
li{font-size:14px;margin-bottom:6px}
.ok{color:green}
.warn{color:orange}
.err{color:red}
.pending{color:blue}
</style>
</head>

<body>

<h2>
Subir CFDI v√°lidos (Ingreso ¬∑ RIQS740906PQ2)
</h2>

<input type="file" id="xmlInput" accept=".xml" multiple>
<button onclick="procesar()">Procesar y Subir</button>

<h3>Archivos</h3>
<ul id="lista"></ul>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = 'https://cvpbtjlupswbyxenugpz.supabase.co';
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
const TABLA = "ingresosriqs740906pq2";
const RFC_VALIDO = 'RIQS740906PQ2';

let lote = [];

/* ================== PRE-CARGA ================== */
document.getElementById('xmlInput').addEventListener('change', async e=>{
  lote = [];
  const ul = document.getElementById('lista');
  ul.innerHTML = '';

  for(const file of e.target.files){
    try{
      const xmlTxt = await file.text();
      const xml = new DOMParser().parseFromString(xmlTxt,'application/xml');

      const ns = 'http://www.sat.gob.mx/cfd/4';
      const c = xml.getElementsByTagNameNS(ns,'Comprobante')[0];
      const em = xml.getElementsByTagNameNS(ns,'Emisor')[0];
      const re = xml.getElementsByTagNameNS(ns,'Receptor')[0];
      const tfd = [...xml.getElementsByTagName('*')]
        .find(n=>n.localName==='TimbreFiscalDigital');

      if(!c || !em || !re || !tfd) throw 'XML incompleto';

      const uuid = tfd.getAttribute('UUID')?.toUpperCase();
      const tipo = c.getAttribute('TipoDeComprobante');
      const rfcEmisor = em.getAttribute('Rfc')?.toUpperCase();

      if(!uuid) throw 'Sin UUID';
      if(tipo!=='I') throw 'No es Ingreso';
      if(rfcEmisor!==RFC_VALIDO) throw 'RFC inv√°lido';
      if(lote.some(x=>x.uuid===uuid)) throw 'Duplicado en lote';

      const fechaRaw = c.getAttribute('Fecha') || tfd.getAttribute('FechaTimbrado');
      const fecha = new Date(fechaRaw).toISOString();

      lote.push({
        uuid_cfdi: uuid,
        fecha,
        periodo_mes: fecha.slice(5,7),
        periodo_anio: fecha.slice(0,4),
        tipo_factura: re.getAttribute('Rfc')==='XAXX010101000'?'GLOBAL':'INDIVIDUAL',
        rfc_emisor: rfcEmisor,
        razon_social_emisor: em.getAttribute('Nombre'),
        rfc_receptor: re.getAttribute('Rfc'),
        razon_social_receptor: re.getAttribute('Nombre'),
        serie: c.getAttribute('Serie'),
        folio: c.getAttribute('Folio'),
        subtotal: Number(c.getAttribute('SubTotal')||0),
        descuento: Number(c.getAttribute('Descuento')||0),
        total: Number(c.getAttribute('Total')||0),
        moneda: c.getAttribute('Moneda'),
        forma_pago: c.getAttribute('FormaPago'),
        metodo_pago: c.getAttribute('MetodoPago'),
        uso_cfdi: re.getAttribute('UsoCFDI'),
        fecha_certificacion: tfd.getAttribute('FechaTimbrado')
          ? new Date(tfd.getAttribute('FechaTimbrado')).toISOString()
          : null,
        total_iva: null,
        total_ieps: null,
        conceptos: null
      });

      ul.innerHTML += `<li data-u="${uuid}">üìÑ ${uuid} <span class="pending">‚Üí Precargado</span></li>`;
    }catch(err){
      ul.innerHTML += `<li class="err">‚ùå ${file.name} (${err})</li>`;
    }
  }
});

/* ================== INSERT ================== */
async function procesar(){
  for(const r of lote){
    const li = document.querySelector(`li[data-u="${r.uuid_cfdi}"] span`);
    li.textContent = '‚Üí Insertando‚Ä¶';

    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLA}`,{
      method:'POST',
      headers:{
        apikey:API_KEY,
        Authorization:`Bearer ${API_KEY}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify(r)
    });

    if(res.status===201){
      li.textContent='‚úÖ Insertado';
      li.className='ok';
    }else if(res.status===409){
      li.textContent='‚ö†Ô∏è Ya existe';
      li.className='warn';
    }else{
      li.textContent='‚ùå Error';
      li.className='err';
      console.error(await res.text());
    }
  }
}
</script>

<footer style="margin-top:40px;font-size:13px;color:#555;border-top:1px solid #ccc;padding-top:10px">
‚öôÔ∏è POWERED BY <b>PROVSOFT</b> ¬∑ 2026
</footer>

</body>
</html>
