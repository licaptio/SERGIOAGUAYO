<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ü©∫ Gastos M√©dicos ‚Äì XML Inge Sergio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =========================================================
       1Ô∏è‚É£ BLOQUE 1: FUENTES Y LIBRER√çAS
       ========================================================= -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- =========================================================
       2Ô∏è‚É£ BLOQUE 2: ESTILOS GENERALES
       ========================================================= -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
    }

    /* üßæ Tabla principal */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      display: block;
      max-height: 80vh;
      overflow-y: auto;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
    }

    th {
      background: #003366;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:hover { background: #f3f7fb; }

    /* üåô Fondo opaco detr√°s del tooltip */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      z-index: 9998;
    }

    /* üí¨ Tooltip modal */
    #previewTooltip {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 500px;
      max-height: 400px;
      overflow-y: auto;
      font-family: Poppins, sans-serif;
      z-index: 9999;
      opacity: 0;
      transition: all 0.25s ease;
      display: none;
    }

    #previewTooltip.visible {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>

<body>

  <!-- =========================================================
       3Ô∏è‚É£ BLOQUE 3: ENCABEZADO Y TABLA
       ========================================================= -->
  <h2>ü©∫ Gastos M√©dicos ‚Äì XML Inge Sergio</h2>

  <table id="tablaGastos">
<thead>
  <tr>
    <th>Fecha</th>
    <th>RFC Emisor</th>
    <th>UUID</th>   <!-- ‚¨ÖÔ∏è AGREGADO -->
    <th>Raz√≥n Social</th>
    <th>Serie</th>
    <th>Factura</th>
    <th>Total</th>
    <th>Nota Reclamaci√≥n</th>
    <th>Especialidad</th>
    <th>Gasto Reclamado</th>
    <th>Fecha Reclamaci√≥n</th>
    <th>Foto</th>
  </tr>
</thead>

    <tbody></tbody>
  </table>

  <!-- =========================================================
       4Ô∏è‚É£‚Äì8Ô∏è‚É£ BLOQUE DE L√ìGICA (SUPABASE + FUNCIONES)
       ========================================================= -->
  <script type="module">

    /* ----------------------------------------
       4Ô∏è‚É£ BLOQUE 4: CONFIGURACI√ìN DE SUPABASE
       ---------------------------------------- */
    const supabaseUrl = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    /* ----------------------------------------
       5Ô∏è‚É£ BLOQUE 5: CONSULTA TABLA PRINCIPAL
       ---------------------------------------- */
    const { data, error } = await supabase
      .from("xml_inge_sergio")
      .select("*")
      .eq("es_gasto_medico", true)
      .order("fecha", { ascending: true });

if (error) {
  console.error("‚ùå Error al consultar Supabase:", error);
  alert("Error al cargar los registros.");
} else {
  /* el resto del c√≥digo que renderiza la tabla */
}


    /* ----------------------------------------
       6Ô∏è‚É£ BLOQUE 6: RENDERIZADO DE TABLA
       ---------------------------------------- */
    const tbody = document.querySelector("#tablaGastos tbody");
    tbody.innerHTML = "";

    data.forEach(registro => {
      const fechaFormateada = registro.fecha
        ? new Date(registro.fecha).toLocaleDateString("es-MX", {
            day: "2-digit", month: "2-digit", year: "numeric"
          })
        : "";
      const fila = document.createElement("tr");
      if (registro.gasto_reclamado) fila.style.backgroundColor = "#d7f8d7";

      fila.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${registro.rfc_emisor ?? ''}</td>
        <td style="max-width:180px;">
  <div style="display:flex; flex-direction:column;">
    <span style="font-weight:600; color:#0c6cbd;">${registro.uuid ?? ''}</span>

    <button onclick="subirFoto('${registro.uuid}')" 
      style="margin-top:3px; background:#0066cc; color:white; border:none;
             padding:4px 8px; border-radius:5px; cursor:pointer; font-size:11px;">
      üì∏ Tomar / Subir foto
    </button>
  </div>
</td>

        <td>${registro.serie ?? ''}</td>
        <td>${registro.factura ?? ''}</td>
        <td>${registro.total?.toLocaleString("es-MX", { style: "currency", currency: "MXN" }) ?? ''}</td>
        <td>${registro.nota_reclamacion ?? ''}</td>
        <td>
  <select data-id="${registro.id}" data-campo="especialidad" style="border:none; background:transparent;">
    <option value="">-- Selecciona --</option>
    <option value="Cardiolog√≠a" ${registro.especialidad === "Cardiolog√≠a" ? 'selected' : ''}>Cardiolog√≠a</option>
    <option value="Urolog√≠a" ${registro.especialidad === "Urolog√≠a" ? 'selected' : ''}>Urolog√≠a</option>
    <option value="Ginecolog√≠a" ${registro.especialidad === "Ginecolog√≠a" ? 'selected' : ''}>Ginecolog√≠a</option>
    <option value="Oncolog√≠a" ${registro.especialidad === "Oncolog√≠a" ? 'selected' : ''}>Oncolog√≠a</option>
    <option value="Endocrinolog√≠a" ${registro.especialidad === "Endocrinolog√≠a" ? 'selected' : ''}>Endocrinolog√≠a</option>
  </select>
</td>

        <td style="text-align:center;">
          <select data-id="${registro.id}" data-campo="gasto_reclamado" style="border:none; background:transparent;">
            <option value="false" ${!registro.gasto_reclamado ? 'selected' : ''}>No</option>
            <option value="true" ${registro.gasto_reclamado ? 'selected' : ''}>S√≠</option>
          </select>
        </td>
        <td>
          <input type="text"
                 value="${registro.fecha_reclamacion ? new Date(registro.fecha_reclamacion).toLocaleDateString('es-MX', {day:'2-digit', month:'short', year:'numeric'}) : ''}"
                 data-id="${registro.id}"
                 data-campo="fecha_reclamacion"
                 placeholder="DDMMAA"
                 style="border:none; outline:none; background:transparent; width:90px;">
        </td>
        <td id="celdaFotos-${registro.uuid}" style="display:flex; gap:4px;">
  <span style="font-size:10px; color:#777;">Cargando...</span>
</td>

      `;
      tbody.appendChild(fila);
    });
data.forEach(registro => {
  cargarMiniFotos(registro.uuid);
});

    /* ----------------------------------------
       7Ô∏è‚É£ BLOQUE 7: GUARDADO AUTOM√ÅTICO
       ---------------------------------------- */
    tbody.addEventListener("change", async (e) => {
      const target = e.target;
      const id = target.dataset.id;
      const campo = target.dataset.campo;
      if (!id || !campo) return;

      let valor = target.value;

      if (campo === "fecha_reclamacion") {
        const match = valor.match(/^(\d{2})(\d{2})(\d{2})$/);
        if (match) {
          const [_, d, m, a] = match;
          const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
          valor = `${d}-${meses[parseInt(m)-1]}-${2000+parseInt(a)}`;
          target.value = valor;
        }
      }

      if (campo === "gasto_reclamado") valor = valor === "true";

      const { error } = await supabase
        .from("xml_inge_sergio")
        .update({ [campo]: valor })
        .eq("id", id);

if (error) {
  alert("‚ö†Ô∏è Error al guardar cambio");
  console.error(error);
} else {
  const fila = target.closest("tr");
  // ‚úÖ Solo pinta de verde si el campo modificado es "gasto_reclamado"
  if (campo === "gasto_reclamado") {
    fila.style.backgroundColor = valor ? "#d7f8d7" : "";
  }
}

    });

    /* ----------------------------------------
       8Ô∏è‚É£ BLOQUE 8: TOOLTIP (CONCEPTOS DETALLE)
       ---------------------------------------- */
    window.mostrarConceptosRapidos = async function(uuid) {
      const overlay = document.getElementById("overlay");
      const tooltip = document.getElementById("previewTooltip");
      const cont = document.getElementById("tooltipContent");

      overlay.style.display = "block";
      tooltip.style.display = "block";
      setTimeout(() => tooltip.classList.add("visible"), 10);

      cont.innerHTML = "Cargando...";

      const { data, error } = await supabase
        .from("xml_inge_sergio")
        .select("conceptos_detalle")
        .eq("uuid", uuid)
        .single();

      if (error || !data) {
        cont.innerHTML = "<p style='color:red;'>No se pudieron cargar los conceptos.</p>";
        return;
      }

      const conceptos = data.conceptos_detalle || [];
      if (conceptos.length === 0) {
        cont.innerHTML = "<p>Sin conceptos registrados.</p>";
        return;
      }

      let html = "<table style='width:100%; border-collapse:collapse; font-size:13px;'>";
      html += "<tr style='background:#003366;color:white;'><th>Cant.</th><th>Descripci√≥n</th><th>Importe</th></tr>";
      conceptos.forEach(c => {
        html += `<tr>
          <td style='border:1px solid #ddd; padding:4px;'>${c.cantidad ?? 1}</td>
          <td style='border:1px solid #ddd; padding:4px;'>${c.descripcion ?? ''}</td>
          <td style='border:1px solid #ddd; padding:4px;'>$${parseFloat(c.costoUnitario ?? 0).toFixed(2)}</td>
        </tr>`;
      });
      html += "</table>";
      cont.innerHTML = html;
    };

    window.cerrarTooltip = function() {
      const overlay = document.getElementById("overlay");
      const tooltip = document.getElementById("previewTooltip");
      tooltip.classList.remove("visible");
      overlay.style.display = "none";
      setTimeout(() => tooltip.style.display = "none", 200);
    };
  /* ... tu c√≥digo ... */

/* ---------- FUNCION SUBIR FOTO ---------- */

window.subirFoto = function(uuid) {
  const fileInput = document.getElementById("fileInputHidden");

  fileInput.value = "";

  fileInput.onchange = async () => {
    const archivo = fileInput.files[0];
    if (!archivo) return;

    const nombre = `${uuid}/${Date.now()}_${archivo.name}`;

    const { error } = await supabase.storage
      .from("gastos_medicos_fotos")
      .upload(nombre, archivo, {
        cacheControl: "3600",
        upsert: false
      });

    if (error) {
      alert("‚ùå Error al subir la foto");
      console.error(error);
      return;
    }

    alert("üì∏ Foto subida correctamente");
    cargarMiniFotos(uuid);
  };

  fileInput.click();
};
async function cargarMiniFotos(uuid) {
  const celda = document.getElementById(`celdaFotos-${uuid}`);
  if (!celda) return;

  celda.innerHTML = "Cargando...";

  const { data: archivos, error } = await supabase.storage
    .from("gastos_medicos_fotos")
    .list(uuid + "/", { limit: 100 });

  if (error) {
    celda.innerHTML = "<span style='color:red;'>Error</span>";
    console.error(error);
    return;
  }

  celda.innerHTML = "";

  if (!archivos || archivos.length === 0) {
    celda.innerHTML = "<span style='font-size:10px;color:#777;'>Sin fotos</span>";
    return;
  }

  archivos.forEach(a => {
    const { data: urlData } = supabase.storage
      .from("gastos_medicos_fotos")
      .getPublicUrl(uuid + "/" + a.name);

    const img = document.createElement("img");
    img.src = urlData.publicUrl;
    img.style.width = "40px";
    img.style.height = "40px";
    img.style.objectFit = "cover";
    img.style.borderRadius = "4px";
    img.style.cursor = "pointer";

    img.onclick = () => window.open(urlData.publicUrl, "_blank");

    celda.appendChild(img);
  });
}

  </script>

  <!-- =========================================================
       9Ô∏è‚É£ BLOQUE 9: COMPONENTES VISUALES (MODAL + OVERLAY)
       ========================================================= -->
  <div id="overlay" onclick="cerrarTooltip()"></div>

  <div id="previewTooltip">
    <h3 style="margin-top:0; color:#003366;">üßæ Conceptos</h3>
    <div id="tooltipContent"></div>
    <button onclick="cerrarTooltip()" style="
      margin-top:10px;
      padding:6px 12px;
      background:#003366;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;">Cerrar</button>
  </div>
<input type="file" id="fileInputHidden" accept="image/*" capture="environment" style="display:none;">

</body>
</html>
