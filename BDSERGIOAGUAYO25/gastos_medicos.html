<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ðŸ©º Gastos MÃ©dicos â€“ XML Inge Sergio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =========================================================
       1ï¸âƒ£ BLOQUE 1: FUENTES Y LIBRERÃAS
       ========================================================= -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- =========================================================
       2ï¸âƒ£ BLOQUE 2: ESTILOS GENERALES
       ========================================================= -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
    }

    /* ðŸ§¾ Tabla principal */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      display: block;
      max-height: 80vh;
      overflow-y: auto;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
    }

    th {
      background: #003366;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:hover { background: #f3f7fb; }

    /* ðŸŒ™ Fondo opaco detrÃ¡s del tooltip */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      z-index: 9998;
    }

    /* ðŸ’¬ Tooltip modal */
    #previewTooltip {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 500px;
      max-height: 400px;
      overflow-y: auto;
      font-family: Poppins, sans-serif;
      z-index: 9999;
      opacity: 0;
      transition: all 0.25s ease;
      display: none;
    }

    #previewTooltip.visible {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>

<body>

  <!-- =========================================================
       3ï¸âƒ£ BLOQUE 3: ENCABEZADO Y TABLA
       ========================================================= -->
  <h2>ðŸ©º Gastos MÃ©dicos â€“ XML Inge Sergio</h2>

  <table id="tablaGastos">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>RFC Emisor</th>
        <th>RazÃ³n Social</th>
        <th>Serie</th>
        <th>Factura</th>
        <th>Total</th>
        <th>Nota ReclamaciÃ³n</th>
        <th>Especialidad</th>
        <th>Gasto Reclamado</th>
        <th>Fecha ReclamaciÃ³n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- =========================================================
       4ï¸âƒ£â€“8ï¸âƒ£ BLOQUE DE LÃ“GICA (SUPABASE + FUNCIONES)
       ========================================================= -->
  <script type="module">

    /* ----------------------------------------
       4ï¸âƒ£ BLOQUE 4: CONFIGURACIÃ“N DE SUPABASE
       ---------------------------------------- */
    const supabaseUrl = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    /* ----------------------------------------
       5ï¸âƒ£ BLOQUE 5: CONSULTA TABLA PRINCIPAL
       ---------------------------------------- */
    const { data, error } = await supabase
      .from("xml_inge_sergio")
      .select("*")
      .eq("es_gasto_medico", true)
      .order("fecha", { ascending: true });

if (error) {
  console.error("âŒ Error al consultar Supabase:", error);
  alert("Error al cargar los registros.");
} else {
  /* el resto del cÃ³digo que renderiza la tabla */
}


    /* ----------------------------------------
       6ï¸âƒ£ BLOQUE 6: RENDERIZADO DE TABLA
       ---------------------------------------- */
    const tbody = document.querySelector("#tablaGastos tbody");
    tbody.innerHTML = "";

    data.forEach(registro => {
      const fechaFormateada = registro.fecha
        ? new Date(registro.fecha).toLocaleDateString("es-MX", {
            day: "2-digit", month: "2-digit", year: "numeric"
          })
        : "";

      const fila = document.createElement("tr");
      if (registro.gasto_reclamado) fila.style.backgroundColor = "#d7f8d7";

      fila.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${registro.rfc_emisor ?? ''}</td>
        <td>
          <a href="#" onclick="mostrarConceptosRapidos('${registro.uuid}'); return false;"
             style="color:#00416A; font-weight:600; text-decoration:none;">
             ${registro.razon_social_emisor ?? ''}
          </a>
        </td>
        <td>${registro.serie ?? ''}</td>
        <td>${registro.factura ?? ''}</td>
        <td>${registro.total?.toLocaleString("es-MX", { style: "currency", currency: "MXN" }) ?? ''}</td>
        <td>${registro.nota_reclamacion ?? ''}</td>
        <td>
  <select data-id="${registro.id}" data-campo="especialidad" style="border:none; background:transparent;">
    <option value="">-- Selecciona --</option>
    <option value="CardiologÃ­a" ${registro.especialidad === "CardiologÃ­a" ? 'selected' : ''}>CardiologÃ­a</option>
    <option value="UrologÃ­a" ${registro.especialidad === "UrologÃ­a" ? 'selected' : ''}>UrologÃ­a</option>
    <option value="GinecologÃ­a" ${registro.especialidad === "GinecologÃ­a" ? 'selected' : ''}>GinecologÃ­a</option>
    <option value="OncologÃ­a" ${registro.especialidad === "OncologÃ­a" ? 'selected' : ''}>OncologÃ­a</option>
    <option value="EndocrinologÃ­a" ${registro.especialidad === "EndocrinologÃ­a" ? 'selected' : ''}>EndocrinologÃ­a</option>
  </select>
</td>

        <td style="text-align:center;">
          <select data-id="${registro.id}" data-campo="gasto_reclamado" style="border:none; background:transparent;">
            <option value="false" ${!registro.gasto_reclamado ? 'selected' : ''}>No</option>
            <option value="true" ${registro.gasto_reclamado ? 'selected' : ''}>SÃ­</option>
          </select>
        </td>
        <td>
          <input type="text"
                 value="${registro.fecha_reclamacion ? new Date(registro.fecha_reclamacion).toLocaleDateString('es-MX', {day:'2-digit', month:'short', year:'numeric'}) : ''}"
                 data-id="${registro.id}"
                 data-campo="fecha_reclamacion"
                 placeholder="DDMMAA"
                 style="border:none; outline:none; background:transparent; width:90px;">
        </td>
      `;
      tbody.appendChild(fila);
    });

    /* ----------------------------------------
       7ï¸âƒ£ BLOQUE 7: GUARDADO AUTOMÃTICO
       ---------------------------------------- */
    tbody.addEventListener("change", async (e) => {
      const target = e.target;
      const id = target.dataset.id;
      const campo = target.dataset.campo;
      if (!id || !campo) return;

      let valor = target.value;

      if (campo === "fecha_reclamacion") {
        const match = valor.match(/^(\d{2})(\d{2})(\d{2})$/);
        if (match) {
          const [_, d, m, a] = match;
          const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
          valor = `${d}-${meses[parseInt(m)-1]}-${2000+parseInt(a)}`;
          target.value = valor;
        }
      }

      if (campo === "gasto_reclamado") valor = valor === "true";

      const { error } = await supabase
        .from("xml_inge_sergio")
        .update({ [campo]: valor })
        .eq("id", id);

if (error) {
  alert("âš ï¸ Error al guardar cambio");
  console.error(error);
} else {
  const fila = target.closest("tr");
  // âœ… Solo pinta de verde si el campo modificado es "gasto_reclamado"
  if (campo === "gasto_reclamado") {
    fila.style.backgroundColor = valor ? "#d7f8d7" : "";
  }
}

    });

    /* ----------------------------------------
       8ï¸âƒ£ BLOQUE 8: TOOLTIP (CONCEPTOS DETALLE)
       ---------------------------------------- */
    window.mostrarConceptosRapidos = async function(uuid) {
      const overlay = document.getElementById("overlay");
      const tooltip = document.getElementById("previewTooltip");
      const cont = document.getElementById("tooltipContent");

      overlay.style.display = "block";
      tooltip.style.display = "block";
      setTimeout(() => tooltip.classList.add("visible"), 10);

      cont.innerHTML = "Cargando...";

      const { data, error } = await supabase
        .from("xml_inge_sergio")
        .select("conceptos_detalle")
        .eq("uuid", uuid)
        .single();

      if (error || !data) {
        cont.innerHTML = "<p style='color:red;'>No se pudieron cargar los conceptos.</p>";
        return;
      }

      const conceptos = data.conceptos_detalle || [];
      if (conceptos.length === 0) {
        cont.innerHTML = "<p>Sin conceptos registrados.</p>";
        return;
      }

      let html = "<table style='width:100%; border-collapse:collapse; font-size:13px;'>";
      html += "<tr style='background:#003366;color:white;'><th>Cant.</th><th>DescripciÃ³n</th><th>Importe</th></tr>";
      conceptos.forEach(c => {
        html += `<tr>
          <td style='border:1px solid #ddd; padding:4px;'>${c.cantidad ?? 1}</td>
          <td style='border:1px solid #ddd; padding:4px;'>${c.descripcion ?? ''}</td>
          <td style='border:1px solid #ddd; padding:4px;'>$${parseFloat(c.costoUnitario ?? 0).toFixed(2)}</td>
        </tr>`;
      });
      html += "</table>";
      cont.innerHTML = html;
    };

    window.cerrarTooltip = function() {
      const overlay = document.getElementById("overlay");
      const tooltip = document.getElementById("previewTooltip");
      tooltip.classList.remove("visible");
      overlay.style.display = "none";
      setTimeout(() => tooltip.style.display = "none", 200);
    };
  </script>

  <!-- =========================================================
       9ï¸âƒ£ BLOQUE 9: COMPONENTES VISUALES (MODAL + OVERLAY)
       ========================================================= -->
  <div id="overlay" onclick="cerrarTooltip()"></div>

  <div id="previewTooltip">
    <h3 style="margin-top:0; color:#003366;">ðŸ§¾ Conceptos</h3>
    <div id="tooltipContent"></div>
    <button onclick="cerrarTooltip()" style="
      margin-top:10px;
      padding:6px 12px;
      background:#003366;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;">Cerrar</button>
  </div>

</body>
</html>
