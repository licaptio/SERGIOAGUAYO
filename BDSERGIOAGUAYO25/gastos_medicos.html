<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ü©∫ Gastos M√©dicos ‚Äì XML Inge Sergio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      display: block;
      max-height: 80vh;
      overflow-y: auto;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
    }

    th {
      background: #003366;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:hover { background: #f3f7fb; }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      z-index: 9998;
    }

    #previewTooltip {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 500px;
      max-height: 400px;
      overflow-y: auto;
      font-family: Poppins, sans-serif;
      z-index: 9999;
      opacity: 0;
      transition: all 0.25s ease;
      display: none;
    }

    #previewTooltip.visible {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>

<body>

<h2>ü©∫ Gastos M√©dicos ‚Äì XML Inge Sergio</h2>

<table id="tablaGastos">
<thead>
  <tr>
    <th>Fecha</th>
    <th>RFC Emisor</th>
    <th>UUID</th>
    <th>Raz√≥n Social</th>
    <th>Serie</th>
    <th>Factura</th>
    <th>Total</th>
    <th>Nota Reclamaci√≥n</th>
    <th>Especialidad</th>
    <th>Gasto Reclamado</th>
    <th>Fecha Reclamaci√≥n</th>
    <th>Foto</th>
  </tr>
</thead>
<tbody></tbody>
</table>

<script type="module">

/* === SUPABASE === */
const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

/* === CONSULTA === */
const { data, error } = await supabase
  .from("xml_inge_sergio")
  .select("*")
  .eq("es_gasto_medico", true)
  .order("fecha", { ascending: true });

if (error) {
  alert("Error al cargar datos");
  console.error(error);
}

const tbody = document.querySelector("#tablaGastos tbody");
tbody.innerHTML = "";

/* === RENDER FILAS === */
data.forEach(registro => {
  const fechaFormateada = registro.fecha
    ? new Date(registro.fecha).toLocaleDateString("es-MX")
    : "";

  const fila = document.createElement("tr");
  if (registro.gasto_reclamado) fila.style.backgroundColor = "#d7f8d7";

  fila.innerHTML = `
    <td>${fechaFormateada}</td>
    <td>${registro.rfc_emisor ?? ''}</td>

    <!-- COLUMNA UUID + BOT√ìN SUBIR FOTO -->
    <td style="max-width:180px;">
      <div style="display:flex; flex-direction:column;">
        <span style="font-weight:600; color:#0c6cbd;">${registro.uuid}</span>
        <button onclick="subirFoto('${registro.uuid}')"
          style="margin-top:3px; background:#0066cc; color:white; border:none;
          padding:4px 8px; border-radius:5px; cursor:pointer; font-size:11px;">
          üì∏ Tomar / Subir foto
        </button>
      </div>
    </td>

    <td>${registro.razon_social_emisor ?? ''}</td>
    <td>${registro.serie ?? ''}</td>
    <td>${registro.factura ?? ''}</td>
    <td>${registro.total?.toLocaleString("es-MX",{style:"currency",currency:"MXN"}) ?? ''}</td>
    <td>${registro.nota_reclamacion ?? ''}</td>

    <td>
      <select data-id="${registro.id}" data-campo="especialidad" style="border:none; background:transparent;">
        <option value="">-- Selecciona --</option>
        <option value="Cardiolog√≠a"${registro.especialidad==="Cardiolog√≠a"?' selected':''}>Cardiolog√≠a</option>
        <option value="Urolog√≠a"${registro.especialidad==="Urolog√≠a"?' selected':''}>Urolog√≠a</option>
        <option value="Ginecolog√≠a"${registro.especialidad==="Ginecolog√≠a"?' selected':''}>Ginecolog√≠a</option>
        <option value="Oncolog√≠a"${registro.especialidad==="Oncolog√≠a"?' selected':''}>Oncolog√≠a</option>
        <option value="Endocrinolog√≠a"${registro.especialidad==="Endocrinolog√≠a"?' selected':''}>Endocrinolog√≠a</option>
      </select>
    </td>

    <td>
      <select data-id="${registro.id}" data-campo="gasto_reclamado" style="border:none; background:transparent;">
        <option value="false"${!registro.gasto_reclamado?' selected':''}>No</option>
        <option value="true"${registro.gasto_reclamado?' selected':''}>S√≠</option>
      </select>
    </td>

    <td>
      <input type="text"
        value="${registro.fecha_reclamacion ? new Date(registro.fecha_reclamacion).toLocaleDateString('es-MX') : ''}"
        data-id="${registro.id}"
        data-campo="fecha_reclamacion"
        placeholder="DDMMAA"
        style="border:none; outline:none; background:transparent; width:90px;">
    </td>

    <td id="celdaFotos-${registro.uuid}" style="display:flex; gap:4px;">
      <span style="font-size:10px;color:#777;">Cargando...</span>
    </td>
  `;

  tbody.appendChild(fila);
});

/* === CARGAR MINIATURAS === */
data.forEach(registro => {
  cargarMiniFotos(registro.uuid);
});

/* === SUBIR FOTO === */
window.subirFoto = function(uuid) {
  const input = document.getElementById("fileInputHidden");
  input.value = "";
  input.onchange = async () => {
    const archivo = input.files[0];
    if (!archivo) return;

    const nombre = `${uuid}/${Date.now()}_${archivo.name}`;

    const { error } = await supabase.storage
      .from("gastos_medicos_fotos")
      .upload(nombre, archivo);

    if (error) {
      alert("Error al subir foto");
      return;
    }

    cargarMiniFotos(uuid);
    alert("Foto subida correctamente");
  };

  input.click();
};

/* === MINIATURAS === */
async function cargarMiniFotos(uuid) {
  const celda = document.getElementById(`celdaFotos-${uuid}`);
  celda.innerHTML = "Cargando...";

  const { data: archivos } = await supabase.storage
    .from("gastos_medicos_fotos")
    .list(uuid + "/", { limit: 50 });

  celda.innerHTML = "";

  if (!archivos || archivos.length === 0) {
    celda.innerHTML = "<span style='font-size:10px;color:#777;'>Sin fotos</span>";
    return;
  }

  archivos.forEach(a => {
    const { data: url } = supabase.storage
      .from("gastos_medicos_fotos")
      .getPublicUrl(uuid + "/" + a.name);

    const img = document.createElement("img");
    img.src = url.publicUrl;
    img.style.width = "40px";
    img.style.height = "40px";
    img.style.objectFit = "cover";
    img.style.borderRadius = "4px";
    img.style.cursor = "pointer";
    img.onclick = () => window.open(url.publicUrl, "_blank");

    celda.appendChild(img);
  });
}

</script>

<input type="file" id="fileInputHidden" accept="image/*" capture="environment" style="display:none;">

</body>
</html>
