<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ü©∫ Gastos M√©dicos ‚Äì XML Inge Sergio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =========================================================
       üß© BLOQUE 1: FUENTES Y LIBRER√çAS
       ========================================================= -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- =========================================================
       üé® BLOQUE 2: ESTILOS GENERALES
       ========================================================= -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
    }

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  display: block;              /* üëà permite scroll interno */
  max-height: 80vh;            /* üëà altura m√°xima visible */
  overflow-y: auto;            /* üëà activa scroll vertical */
}

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
    }

th {
  background: #003366;
  color: #fff;
  position: sticky;            /* üëà mantiene fijo el encabezado */
  top: 0;                      /* üëà anclado a la parte superior */
  z-index: 2;                  /* üëà evita que se tape */
}

    tr:hover { background: #f3f7fb; }

    .true { color: green; font-weight: 600; }
    .false { color: red; font-weight: 600; }
  </style>
</head>

<body>
  <!-- =========================================================
       üßæ BLOQUE 3: ENCABEZADO Y TABLA
       ========================================================= -->
  <h2>ü©∫ Gastos M√©dicos ‚Äì XML Inge Sergio</h2>

  <table id="tablaGastos">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>RFC Emisor</th>
        <th>Raz√≥n Social</th>
        <th>Serie</th>
        <th>Factura</th>
        <th>Total</th>
        <th>Nota Reclamaci√≥n</th>
        <th>Especialidad</th>
        <th>Gasto Reclamado</th>
        <th>Fecha Reclamaci√≥n</th>
       </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- =========================================================
       ‚öôÔ∏è BLOQUE 4: CONFIGURACI√ìN DE SUPABASE
       ========================================================= -->
  <script type="module">
    // üîë CONFIGURA AQU√ç TUS DATOS DE SUPABASE
    const supabaseUrl = "https://cvpbtjlupswbyxenugpz.supabase.co"; // üëâ tu URL
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"; // üëâ reemplaza con tu key p√∫blica
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// =========================================================
// üì§ BLOQUE 5: CONSULTA A LA TABLA XML_INGE_SERGIO
// =========================================================
const { data, error } = await supabase
  .from("xml_inge_sergio")
  .select("*")
  .eq("es_gasto_medico", true) // üîé filtro principal
  .order("fecha", { ascending: true }); // üïí de m√°s viejo a m√°s reciente

if (error) {
  console.error("Error al consultar la tabla:", error);
  alert("‚ö†Ô∏è Error al obtener los datos. Revisa la consola.");
} else {
// =========================================================
// üßÆ BLOQUE 6: CONSTRUCCI√ìN DE TABLA (EDITABLE CON FORMATO)
// =========================================================
const tbody = document.querySelector("#tablaGastos tbody");
tbody.innerHTML = "";

data.forEach(registro => {
  const fechaFormateada = registro.fecha
    ? new Date(registro.fecha).toLocaleDateString("es-MX", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      })
    : "";

const fila = document.createElement("tr");

// üé® Si el registro ya fue reclamado, pinta la fila de verde bajito
if (registro.gasto_reclamado) {
  fila.style.backgroundColor = "#d7f8d7"; // verde pastel suave
}

fila.innerHTML = `

    <td>${fechaFormateada}</td>
    <td>${registro.rfc_emisor ?? ''}</td>
    <td>${registro.razon_social_emisor ?? ''}</td>
    <td>${registro.serie ?? ''}</td>
    <td>${registro.factura ?? ''}</td>
    <td>${registro.total?.toLocaleString("es-MX", { style: "currency", currency: "MXN" }) ?? ''}</td>
    <td>${registro.nota_reclamacion ?? ''}</td>
    <td>${registro.especialidad ?? ''}</td>
    <!-- ‚úÖ Campo editable: GASTO RECLAMADO (S√≠/No) -->
    <td style="text-align:center;">
      <select data-id="${registro.id}" data-campo="gasto_reclamado" style="border:none; background:transparent;">
        <option value="false" ${!registro.gasto_reclamado ? 'selected' : ''}>No</option>
        <option value="true" ${registro.gasto_reclamado ? 'selected' : ''}>S√≠</option>
      </select>
    </td>

    <!-- ‚úèÔ∏è Campo editable: FECHA RECLAMACI√ìN -->
    <td>
      <input type="text" value="${registro.fecha_reclamacion ? new Date(registro.fecha_reclamacion).toLocaleDateString('es-MX', {day:'2-digit', month:'short', year:'numeric'}) : ''}"
             data-id="${registro.id}" data-campo="fecha_reclamacion"
             placeholder="DDMMAA"
             style="border:none; outline:none; background:transparent; width:90px;">
    </td>
  `;
  tbody.appendChild(fila);
});

// =========================================================
// üíæ BLOQUE 7: EVENTOS DE ACTUALIZACI√ìN AUTOM√ÅTICA + FORMATEO
// =========================================================
tbody.addEventListener("change", async (e) => {
  const target = e.target;
  const id = target.dataset.id;
  const campo = target.dataset.campo;
  if (!id || !campo) return;

  let valor = target.value;

// üóìÔ∏è Si es fecha_reclamacion y se teclea como 160725 => 16-Jul-2025
if (campo === "fecha_reclamacion") {
  const match = valor.match(/^(\d{2})(\d{2})(\d{2})$/);
  if (match) {
    const [_, dia, mes, anio] = match;
    const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
    const mesNombre = meses[parseInt(mes) - 1] ?? "";

    // ‚úÖ construir el a√±o correctamente
    const anioCompleto = 2000 + parseInt(anio);  
    valor = `${dia}-${mesNombre}-${anioCompleto}`;

    target.value = valor; // mostrar en input formateado
  }
}

  // ‚öôÔ∏è Convertir "true"/"false" a booleano real
  if (campo === "gasto_reclamado") {
    valor = valor === "true";
  }

  // üíæ Guardar cambio en Supabase
  const { error } = await supabase
    .from("xml_inge_sergio")
    .update({ [campo]: valor })
    .eq("id", id);

  if (error) {
    console.error("‚ùå Error al actualizar:", error);
    alert("‚ö†Ô∏è No se pudo guardar el cambio");
  } else {
    console.log(`‚úÖ ${campo} actualizado correctamente para ID ${id}`);
    if (campo === "gasto_reclamado") {
  // üîÑ Cambia el color de la fila visualmente al guardar
  const fila = target.closest("tr");
  if (valor === true) {
    fila.style.backgroundColor = "#d7f8d7"; // reclamado = verde suave
  } else {
    fila.style.backgroundColor = ""; // sin color si vuelve a "No"
  }
}

  }
});


}

  </script>
</body>
</html>
