<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ü©∫ Gastos M√©dicos ‚Äì Clon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      padding:20px;
    }
    h2{text-align:center;color:#003366;margin-bottom:25px}
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 3px 8px rgba(0,0,0,.15);
      display:block;
      max-height:80vh;
      overflow-y:auto;
    }
    th,td{
      padding:8px 10px;
      border-bottom:1px solid #ddd;
      font-size:13px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      background:#003366;
      color:#fff;
      position:sticky;
      top:0;
      z-index:2;
    }
    tr:hover{background:#f3f7fb}
    .uuid{
      font-weight:600;
      color:#0c6cbd;
      font-family:monospace;
    }
    .info{
      color:#555;
    }
.icons{
  text-align:center;
  font-size:15px;
  letter-spacing:2px;
  white-space:nowrap;
}
.icons.fotos{ color:#2e7d32; }
.icons.pdf{ color:#c62828; }
.icons.xml{ color:#1565c0; }

/* üñ•Ô∏è OCULTAR CARDS EN PC */
.card-list{
  display:none;
}

/* üì± CARDS EN CELULAR */
@media (max-width: 768px){

  table, thead{
    display:none;
  }

  .card-list{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .card-item{
    background:#fff;
    border-radius:12px;
    padding:14px;
    box-shadow:0 3px 8px rgba(0,0,0,.15);
    font-size:13px;
  }

  .card-item .row{
    margin-bottom:6px;
  }

  .label{
    font-weight:600;
    color:#555;
  }

  .uuid a{
    font-family:monospace;
    font-size:12px;
  }
}
.icon-btn{
  background:none;
  border:none;
  cursor:pointer;
  font-size:16px;
  padding:4px;
}

.icon-btn:hover{
  transform:scale(1.15);
  filter:brightness(1.2);
}

  </style>
</head>

<body>

<h2>ü©∫ Gastos M√©dicos ‚Äì Clon</h2>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>UUID</th>
  <th>Raz√≥n Social</th>
  <th>Serie / Factura</th>
  <th>Total</th>
  <th>Especialidad</th>
  <th>Gasto Reclamado</th>
  <th>Fecha Reclamaci√≥n</th>
  <th>Fotos</th>
<th>PDF</th>
<th>XML</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<!-- üì± CONTENEDOR PARA CELULAR -->
<div id="cards" class="card-list"></div>
<script type="module">
const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

const { data, error } = await supabase
  .from("xml_inge_sergio_e")
  .select("*")
  .eq("es_gasto_medico", true)
  .order("fecha", { ascending: true });

if(error){
  alert("Error al cargar datos");
  console.error(error);
}

const tbody = document.getElementById("tbody");
tbody.innerHTML = "";

const cards = document.getElementById("cards");

data.forEach(r => {
  /* ================= TABLA (PC) ================= */
  const tr = document.createElement("tr");
  if (r.gasto_reclamado) tr.style.background = "#d7f8d7";

  const uuidCorto = r.uuid ? r.uuid.substring(0, 18) + "‚Ä¶" : "";

  tr.innerHTML = `
    <td>${r.fecha ? new Date(r.fecha).toLocaleDateString("es-MX") : ""}</td>
    <td class="uuid">
      <a href="detalle.html?uuid=${r.uuid}" style="color:#0c6cbd;text-decoration:none;">
        ${uuidCorto}
      </a>
    </td>
    <td>${r.razon_social_emisor ?? ""}</td>
    <td>${r.serie ?? ""} - ${r.factura ?? ""}</td>
    <td>${r.total?.toLocaleString("es-MX",{style:"currency",currency:"MXN"}) ?? ""}</td>
    <td class="info">${r.especialidad ?? ""}</td>
    <td class="info">${r.gasto_reclamado ? "S√≠" : "No"}</td>
    <td class="info">
      ${r.fecha_reclamacion ? new Date(r.fecha_reclamacion).toLocaleDateString("es-MX") : ""}
    </td>
<td class="icons fotos">${btnFotos(r.fotos, r.uuid)}</td>
<td class="icons pdf">${btnPDF(r.pdf)}</td>
<td class="icons xml">${btnXML(r.xml)}</td>
  `;

  tbody.appendChild(tr);

  /* ================= CARDS (CELULAR) ================= */
  const card = document.createElement("div");
  card.className = "card-item";

  card.innerHTML = `
    <div class="row"><span class="label">Fecha:</span>
      ${r.fecha ? new Date(r.fecha).toLocaleDateString("es-MX") : ""}
    </div>

    <div class="row uuid"><span class="label">UUID:</span>
      <a href="detalle.html?uuid=${r.uuid}">
        ${r.uuid}
      </a>
    </div>

    <div class="row"><span class="label">Raz√≥n Social:</span>
      ${r.razon_social_emisor ?? ""}
    </div>

    <div class="row"><span class="label">Factura:</span>
      ${r.serie ?? ""} - ${r.factura ?? ""}
    </div>

    <div class="row"><span class="label">Total:</span>
      ${r.total?.toLocaleString("es-MX",{style:"currency",currency:"MXN"}) ?? ""}
    </div>

    <div class="row"><span class="label">Especialidad:</span>
      ${r.especialidad ?? ""}
    </div>

    <div class="row"><span class="label">Reclamado:</span>
      ${r.gasto_reclamado ? "S√≠" : "No"}
    </div>
  `;

  cards.appendChild(card);
});
function iconosFotos(fotos) {
  if (!Array.isArray(fotos)) return '';
  if (fotos.length === 0) return '';
  if (fotos.length <= 4) return 'üì∏'.repeat(fotos.length);
  return 'üì∏üì∏üì∏+';
}

function iconoExiste(valor, icono) {
  return valor ? icono : '';
}
function iconoPDF(pdf) {
  if (!pdf) return '';
  if (typeof pdf === 'string' && pdf.trim() === '') return '';
  return 'üìÑ';
}
function iconoXML(xml) {
  if (!xml) return '';
  if (typeof xml === 'string' && xml.trim() === '') return '';
  return 'üßæ';
}
window.verFotos = function(uuid){
  window.open(`fotos.html?uuid=${uuid}`, '_blank');
}

function btnFotos(fotos, uuid) {
  if (!Array.isArray(fotos) || fotos.length === 0) return '';
  return `
    <button class="icon-btn" onclick="verFotos('${uuid}')">
      üì∏${fotos.length > 1 ? `(${fotos.length})` : ''}
    </button>
  `;
}
function btnPDF(pdfArray) {
  if (!Array.isArray(pdfArray)) return '';
  const pdf = pdfArray.find(p => p.toLowerCase().endsWith('.pdf'));
  if (!pdf) return '';
  return `
    <a class="icon-btn" href="${pdf}" target="_blank" title="Abrir PDF">
      üìÑ
    </a>
  `;
}
function btnXML(xml) {
  if (!xml || typeof xml !== 'string') return '';
  if (!xml.toLowerCase().endsWith('.xml')) return '';
  return `
    <a class="icon-btn" href="${xml}" target="_blank" title="Abrir XML">
      üßæ
    </a>
  `;
}

</script>

</body>
</html>

