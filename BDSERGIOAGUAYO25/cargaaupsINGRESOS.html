<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga de XML - Inge Sergio</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    ul { padding: 0; list-style: none; }
    li { margin-bottom: 6px; font-size: 14px; }
    .ok { color: green; }
    .warn { color: orange; }
    .err { color: red; }
    .pending { color: blue; }
  </style>
</head>
<body>
  <h2>Subir EGRESOS (CFDI donde receptor = AUPS540605TF0)</h2>
  <input type="file" id="xmlInput" accept=".xml" multiple>
  <button onclick="procesarArchivos()">Procesar y Subir</button>

  <h3>Archivos</h3>
  <ul id="archivoList"></ul>
  <h3>Bit√°cora</h3>
  <pre id="bitacora" style="background:#eee; padding:10px; max-height:200px; overflow:auto; font-size:13px;"></pre>

  <script>
    const RFC_RECEPTOR_PERMITIDO = "AUPS540605TF0";
    const TABLA_INGRESOS = "xml_inge_sergio_i";
    const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
// ===============================
// ‚öôÔ∏è CONFIGURACI√ìN DE CARGA SEGURA
// ===============================
const TAM_LOTE = 20;     // cu√°ntos XML por bloque
const PAUSA_MS = 500;   // pausa entre bloques (ms)

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

    let archivosDatos = [];

    document.getElementById('xmlInput').addEventListener('change', async function () {
      const lista = document.getElementById('archivoList');
      lista.innerHTML = '';
      archivosDatos = [];

      for (const file of this.files) {
        try {
          const text = await file.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(text, 'application/xml');

          const cfdiNS = "http://www.sat.gob.mx/cfd/4";
          const tfdNS = "http://www.sat.gob.mx/TimbreFiscalDigital";

          const comprobante = xml.getElementsByTagNameNS(cfdiNS, "Comprobante")[0];
          const timbre = xml.getElementsByTagNameNS(tfdNS, "TimbreFiscalDigital")[0];
          const emisor = xml.getElementsByTagNameNS(cfdiNS, "Emisor")[0];
          const receptor = xml.getElementsByTagNameNS(cfdiNS, "Receptor")[0];

          const tipo = comprobante?.getAttribute("TipoDeComprobante");
          const uuid = (timbre?.getAttribute("UUID") || "").toUpperCase().trim().replace(/\s+/g, '');
          const receptorRFC = (receptor?.getAttribute("Rfc") || "").toUpperCase().trim();
          // ======================================================
// üîí VALIDACI√ìN TEMPRANA (PRECARGA)
// ======================================================
let estado = 'VALIDO';
let motivo = '';

if (!uuid || !tipo || !receptorRFC) {
  estado = 'NO_PERMITIDO';
  motivo = 'XML incompleto';
} else if (tipo !== 'I') {
  estado = 'NO_PERMITIDO';
  motivo = `No es ingreso (${tipo})`;
}
// ======================================================

          const emisorRFC = emisor?.getAttribute("Rfc") || "";
          const razonSocial = emisor?.getAttribute("Nombre") || "";
          const nombreReceptor = receptor?.getAttribute("Nombre") || "";
          const folio = comprobante?.getAttribute("Folio") || '';
          const serie = comprobante?.getAttribute("Serie") || '';
          const total = parseFloat(comprobante?.getAttribute("Total")) || 0;
          const fecha = comprobante?.getAttribute("Fecha");
          const fechaTimbrado = timbre?.getAttribute("FechaTimbrado") || null;
          const versionCFDI = comprobante?.getAttribute("Version");
          const lugarExpedicion = comprobante?.getAttribute("LugarExpedicion");
const moneda = comprobante?.getAttribute("Moneda");
const tipoCambio = parseFloat(comprobante?.getAttribute("TipoCambio")) || null;
const metodoPago = comprobante?.getAttribute("MetodoPago");
const formaPago = comprobante?.getAttribute("FormaPago");
const exportacion = comprobante?.getAttribute("Exportacion");
const subtotal = parseFloat(comprobante?.getAttribute("SubTotal")) || 0;
const descuento = parseFloat(comprobante?.getAttribute("Descuento")) || 0;

const regimenEmisor = emisor?.getAttribute("RegimenFiscal");
const usoCFDI = receptor?.getAttribute("UsoCFDI");
const regimenReceptor = receptor?.getAttribute("RegimenFiscalReceptor");
const domicilioFiscalReceptor = receptor?.getAttribute("DomicilioFiscalReceptor");
const xmlRaw = text;

          
          let conceptosDetalle = [];
          const conceptos = xml.getElementsByTagNameNS(cfdiNS, "Concepto");

          for (let c of conceptos) {
            const cantidad = parseFloat(c.getAttribute("Cantidad")) || 0;
            const descripcion = c.getAttribute("Descripcion") || "";
            const codigoSAT = c.getAttribute("ClaveProdServ") || "";
            const valorUnitario = parseFloat(c.getAttribute("ValorUnitario")) || 0;

            let impuestoTasa = 0;
            let tipoImpuesto = "";
            const impuestos = c.getElementsByTagNameNS(cfdiNS, "Impuestos")[0];
            if (impuestos) {
              const traslados = impuestos.getElementsByTagNameNS(cfdiNS, "Traslado");
              for (let t of traslados) {
                const tasa = parseFloat(t.getAttribute("TasaOCuota")) || 0;
                const impuesto = t.getAttribute("Impuesto") || "";
                impuestoTasa += tasa;
                tipoImpuesto = impuesto === '003' ? 'IEPS' : 'IVA';
              }
            }

            conceptosDetalle.push({
              cantidad,
              codigoSAT,
              descripcion,
              costoUnitario: valorUnitario,
              tipoImpuesto: tipoImpuesto || "NINGUNO",
              tasaImpuesto: impuestoTasa
            });
          }

archivosDatos.push({
  uuid,
  tipo_comprobante: tipo,
  version_cfdi: versionCFDI,

  serie,
  folio,
  fecha,
  lugar_expedicion: lugarExpedicion,
  moneda,
  tipo_cambio: tipoCambio,
  metodo_pago: metodoPago,
  forma_pago: formaPago,
  exportacion,

  subtotal,
  descuento,
  total,

  rfc_emisor: emisorRFC,
  nombre_emisor: razonSocial,
  regimen_fiscal_emisor: regimenEmisor,

  rfc_receptor: receptorRFC,
  nombre_receptor: nombreReceptor,
  domicilio_fiscal_receptor: domicilioFiscalReceptor,
  regimen_fiscal_receptor: regimenReceptor,
  uso_cfdi: usoCFDI,

  conceptos: conceptosDetalle, // luego puedes enriquecer
  impuestos: null,             // se puede parsear despu√©s
  complementos: null,

  fecha_timbrado: fechaTimbrado,

  xml_raw: xmlRaw,

  estado,
  motivo
});

const li = document.createElement('li');

if (estado === 'VALIDO') {
  li.innerHTML = `üìÑ <b>${uuid}</b> <span class="pending">VALIDADO</span>`;
} else {
  li.innerHTML = `‚õî <b>${uuid}</b> <span class="err">${motivo}</span>`;
}

lista.appendChild(li);

        } catch (e) {
          const li = document.createElement('li');
          li.innerHTML = `‚ùå <b>${file.name}</b> <span class="err">‚Üí Error al leer</span>`;
          lista.appendChild(li);
        }
      }
    });

async function procesarArchivos() {
  const items = document.querySelectorAll('#archivoList li');

  for (let i = 0; i < archivosDatos.length; i += TAM_LOTE) {

    const bloque = archivosDatos.slice(i, i + TAM_LOTE);
    logBitacora(`üöö Procesando bloque ${i + 1} a ${i + bloque.length}`);

    for (let j = 0; j < bloque.length; j++) {
      const indexReal = i + j;
      const item = items[indexReal];
      const data = bloque[j];

      // ‚õî FILTRO FINAL
      if (data.estado !== 'VALIDO') {
        item.querySelector('span').textContent = `‚õî ${data.motivo}`;
        item.querySelector('span').className = 'err';
        logBitacora(`‚õî ${data.uuid} ‚Üí ${data.motivo}`);
        continue;
      }

      logBitacora(`üìÑ Subiendo UUID: ${data.uuid}`);

  const datosInsert = {
  uuid: data.uuid,
  tipo_comprobante: data.tipo_comprobante,
  version_cfdi: data.version_cfdi,

  serie: data.serie,
  folio: data.folio,
  fecha: data.fecha,
  lugar_expedicion: data.lugar_expedicion,
  moneda: data.moneda,
  tipo_cambio: data.tipo_cambio,
  metodo_pago: data.metodo_pago,
  forma_pago: data.forma_pago,
  exportacion: data.exportacion,

  subtotal: data.subtotal,
  descuento: data.descuento,
  total: data.total,

  rfc_emisor: data.rfc_emisor,
  nombre_emisor: data.nombre_emisor,
  regimen_fiscal_emisor: data.regimen_fiscal_emisor,

  rfc_receptor: data.rfc_receptor,
  nombre_receptor: data.nombre_receptor,
  domicilio_fiscal_receptor: data.domicilio_fiscal_receptor,
  regimen_fiscal_receptor: data.regimen_fiscal_receptor,
  uso_cfdi: data.uso_cfdi,

  conceptos: data.conceptos,
  impuestos: data.impuestos,
  complementos: data.complementos,

  uuid_sat: data.uuid_sat,
  fecha_timbrado: data.fecha_timbrado,

  xml_raw: data.xml_raw
};


      try {
        const insert = await fetch(
          `${SUPABASE_URL}/rest/v1/${TABLA_INGRESOS}?on_conflict=uuid&select=uuid`,
          {
            method: 'POST',
            headers: {
              apikey: API_KEY,
              Authorization: `Bearer ${API_KEY}`,
              'Content-Type': 'application/json',
              Prefer: 'resolution=ignore-duplicates,return=representation'
            },
            body: JSON.stringify(datosInsert)
          }
        );

        if (!insert.ok) {
          const err = await insert.text();
          item.querySelector('span').textContent = `‚ùå ERROR`;
          item.querySelector('span').className = 'err';
          logBitacora(`‚ùå ${data.uuid} ‚Üí ${err}`);
          continue;
        }

        const resp = await insert.json();

        if (Array.isArray(resp) && resp.length === 1) {
          item.querySelector('span').textContent = `‚úÖ CARGADO EN BD`;
          item.querySelector('span').className = 'ok';
          logBitacora(`‚úîÔ∏è ${data.uuid} ‚Üí INSERTADO`);
        } else {
          item.querySelector('span').textContent = `‚ö†Ô∏è YA EXISTE`;
          item.querySelector('span').className = 'warn';
          logBitacora(`‚ö†Ô∏è ${data.uuid} ‚Üí DUPLICADO`);
        }

      } catch (e) {
        item.querySelector('span').textContent = `‚ùå ERROR`;
        item.querySelector('span').className = 'err';
        logBitacora(`‚ùå ${data.uuid} ‚Üí ${e.message}`);
      }
    }

    // ‚è∏Ô∏è PAUSA ENTRE BLOQUES (CLAVE)
    logBitacora(`‚è∏Ô∏è Pausa ${PAUSA_MS} ms`);
    await sleep(PAUSA_MS);
  }

  logBitacora('üèÅ CARGA COMPLETA');
}

    function logBitacora(mensaje) {
      const log = document.getElementById("bitacora");
      log.textContent += mensaje + "\n";
    }
  </script>
</body>
</html>


